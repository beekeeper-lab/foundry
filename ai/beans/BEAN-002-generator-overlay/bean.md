# BEAN-002: Generator Overlay Mode

| Field | Value |
|-------|-------|
| **Bean ID** | BEAN-002 |
| **Status** | Done |
| **Priority** | High |
| **Created** | 2026-02-07 |
| **Owner** | team-lead |
| **Category** | App |

## Problem Statement

The generator currently only outputs to a new directory. When dogfooding Foundry for its own development, we had to generate to a staging directory and manually copy `.claude/` and `ai/` into the project root. This is fragile and doesn't support re-generation (e.g., after adding a persona or changing stacks).

## Goal

Add an overlay mode to the generator that can write `.claude/` and `ai/` directly into an existing project directory, merging with existing content rather than requiring a clean output directory.

## Scope

### In Scope
- New `--overlay` flag for `foundry-cli generate`
- Overlay logic: write generated files into existing project, skip/warn on conflicts
- Conflict detection: report files that differ between generated and existing
- Dry-run mode: show what would change without writing

### Out of Scope
- Automatic merge of conflicting files (user resolves manually)
- GUI support for overlay mode (follow-up bean)

## Acceptance Criteria

- [x] `foundry-cli generate --overlay <dir>` writes into an existing directory
- [x] Existing files not generated by Foundry are left untouched
- [x] Conflicts are reported clearly (file path + reason)
- [x] `--dry-run` flag shows planned changes without writing
- [x] Tests cover overlay, conflict detection, and dry-run scenarios
- [x] All tests pass (`uv run pytest`) — 300 tests
- [x] Lint clean (`uv run ruff check foundry_app/`)

## Tasks

| # | Task | Owner | Depends On | Status |
|---|------|-------|------------|--------|
| 1 | Requirements & scope for overlay mode | ba | — | Done |
| 2 | Design spec for overlay engine | architect | 1 | Done |
| 3 | Implement overlay engine + CLI flags | developer | 2 | Done |
| 4 | Test overlay, conflicts, and dry-run | tech-qa | 3 | Done |

> Task files in `tasks/` subdirectory.

## Notes

This is the highest-priority bean because it directly unblocks iterative use of Foundry on existing projects — the core dogfooding use case.

## Telemetry

| # | Task | Owner | Duration | Tokens In | Tokens Out |
|---|------|-------|----------|-----------|------------|
| 1 | All tasks | team-lead | < 1m | — | — |

| Metric | Value |
|--------|-------|
| **Total Tasks** | 1 |
| **Total Duration** | < 1m |
| **Total Tokens In** | — |
| **Total Tokens Out** | — |

> Duration backfilled from git timestamps (single commit, no merge).
