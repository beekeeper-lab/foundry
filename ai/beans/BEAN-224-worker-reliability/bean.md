# BEAN-224: Parallel Worker Reliability — Commit, Exit, and Watchdog

| Field | Value |
|-------|-------|
| **Bean ID** | BEAN-224 |
| **Status** | Done |
| **Priority** | High |
| **Created** | 2026-02-21 |
| **Started** | 2026-02-21 18:05 |
| **Completed** | 2026-02-21 18:11 |
| **Duration** | 6m |
| **Owner** | team-lead |
| **Category** | Process |

## Problem Statement

In projects generated by Foundry, parallel workers spawned by `/long-run --fast N` frequently stall mid-execution. They fail to commit their work, fail to update their status file to `done`, and fail to exit — leaving tmux windows open indefinitely. The orchestrator then sees no completions and never spawns replacements, effectively halting the entire run after the initial batch.

This has been observed in generated sub-apps. Foundry's own `/long-run` may have the same latent issue but it hasn't been observed yet.

The root causes are likely:
1. Workers running out of context window before reaching the commit/exit steps
2. Workers hitting errors mid-wave and not recovering or exiting cleanly
3. Workers getting stuck in loops (re-reading files, retrying failed operations)
4. No timeout or watchdog mechanism to detect and handle stalled workers
5. Worker prompts don't emphasize commit-early or exit-on-failure patterns

## Goal

Make parallel workers reliably commit their work, update their status file, and exit — even when things go wrong. Add orchestrator-side detection and handling for stalled workers.

## Scope

### In Scope
- Add explicit error-handling and exit instructions to worker prompts (commit what you have, set status to error, exit)
- Add "commit early, commit often" guidance to worker prompts (commit after each task, not just at the end)
- Add stale worker handling to the orchestrator dashboard loop (detect workers with no status update for N minutes, kill and respawn or report)
- Add maximum execution time guidance to worker prompts
- Update library templates (`ai-team-library/claude/`) for generated sub-apps
- Update Foundry's own templates (`.claude/`) to match
- Consider adding a `--timeout` flag or stale threshold to the dashboard loop

### Out of Scope
- Changing the merge responsibility model (stays with orchestrator)
- Fixing specific bean content that causes workers to stall
- Adding retry logic for failed beans (manual intervention is fine)

## Acceptance Criteria

- [x] Worker prompts include explicit error-handling: on failure, commit partial work, set status to `error` with message, and exit
- [x] Worker prompts include incremental commit guidance (after each task completion, not just at the end)
- [x] Orchestrator dashboard loop detects stale workers (10+ minute threshold)
- [x] Orchestrator takes action on stale workers (kill window, remove worktree, mark bean for retry or report)
- [x] Library templates updated (`ai-team-library/claude/`)
- [x] Foundry templates updated (`.claude/`)
- [x] Both template sets are consistent
- [x] All tests pass (`uv run pytest`) — 659 passed
- [x] Lint clean (`uv run ruff check foundry_app/`)

## Tasks

| # | Task | Owner | Depends On | Status |
|---|------|-------|------------|--------|
| 1 | Update worker prompts and dashboard loop for reliability | Developer | — | Done |
| 2 | Verify worker reliability improvements | Tech-QA | 1 | Done |

## Changes

> Auto-populated by `/merge-bean` with the git diff summary.

| File | Lines |
|------|-------|
| .claude/skills/long-run/SKILL.md | ~20 |
| .claude/commands/long-run.md | ~20 |
| .claude/commands/internal/spawn-bean.md | ~40 |
| ai-team-library/claude/skills/long-run/SKILL.md | ~20 |
| ai-team-library/claude/commands/long-run.md | ~20 |
| ai-team-library/claude/commands/spawn-bean.md | ~40 |

## Notes

This bean is independent of BEAN-222 (trunk-based) and BEAN-223 (subtree). It can run before, after, or in parallel with them since it modifies different sections of the same files (worker prompts and dashboard loop, not branch targets).

Key design principles:
- Workers should commit after each task, not just at the end. If a worker stalls on task 3 of 4, at least tasks 1-2 are committed.
- Workers should exit on unrecoverable errors rather than spinning. A dead worker that set `status: error` is better than a live worker that's stuck.
- The orchestrator should not wait forever. A stale threshold (e.g., 10 minutes with no status update) should trigger action.

## Trello

| Field | Value |
|-------|-------|
| **Source** | Manual |

## Telemetry

| # | Task | Owner | Duration | Tokens In | Tokens Out | Cost |
|---|------|-------|----------|-----------|------------|------|
| 1 | Update worker prompts and dashboard loop for reliability | Developer | 3m | 1,526,094 | 300 | $3.03 |
| 2 | Verify worker reliability improvements | Tech-QA | 1m | 2,991,926 | 395 | $4.80 |

| Metric | Value |
|--------|-------|
| **Total Tasks** | 2 |
| **Total Duration** | 4m |
| **Total Tokens In** | 4,518,020 |
| **Total Tokens Out** | 695 |
| **Total Cost** | $7.83 |