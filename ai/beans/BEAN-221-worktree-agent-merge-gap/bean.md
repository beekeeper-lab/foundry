# BEAN-221: Fix Worktree Agent Merge Gap in Generated Apps

| Field | Value |
|-------|-------|
| **Bean ID** | BEAN-221 |
| **Status** | Done |
| **Priority** | High |
| **Created** | 2026-02-21 |
| **Started** | 2026-02-21 16:42 |
| **Completed** | 2026-02-21 16:49 |
| **Duration** | 7m |
| **Owner** | team-lead |
| **Category** | App |

## Problem Statement

Apps generated by Foundry have a broken `/long-run` parallel mode. When beans are processed via isolated git worktrees, the worker agent completes all work and commits on its feature branch, but the branch never gets merged into `test`. This creates a coordination gap: the worker is told not to merge (the orchestrator should handle it), but the orchestrator either doesn't monitor completion, doesn't merge, or cleans up the worktree before merging.

The issue is in the generated skill templates that Foundry produces for sub-apps, not in Foundry's own `/long-run` (which works correctly).

## Goal

Fix the generated long-run and spawn-bean skill templates so that apps created by Foundry have a working parallel worktree merge flow. The orchestrator must reliably merge each worker's feature branch after the worker completes.

## Scope

### In Scope
- Audit Foundry's own long-run skill for the orchestrator merge logic to understand the correct pattern
- Identify the generated skill templates (long-run, spawn-bean, merge-bean) that Foundry outputs for sub-apps
- Fix the generated templates so the orchestrator properly merges worker branches after completion
- Ensure worktree cleanup only happens after successful merge
- Ensure `_index.md` is updated after merge

### Out of Scope
- Changes to Foundry's own `/long-run` behavior (it works correctly)
- Changes to the Foundry application runtime code (services, models, UI)
- Adding new merge strategies or conflict resolution logic

## Acceptance Criteria

- [ ] Generated long-run skill template includes correct orchestrator merge loop that monitors worker status files and merges completed branches
- [ ] Generated spawn-bean skill template includes correct worker instructions (commit but don't merge)
- [ ] Generated merge-bean skill template is included and functional
- [ ] Worktree cleanup in generated templates only occurs after confirmed merge
- [ ] All tests pass (`uv run pytest`)
- [ ] Lint clean (`uv run ruff check foundry_app/`)

## Tasks

| # | Task | Owner | Depends On | Status |
|---|------|-------|------------|--------|
| 1 | Fix library skill templates for worktree merge loop | Developer | â€” | Done |
| 2 | Verify template consistency and correctness | Tech-QA | 1 | Done |

## Changes

> Auto-populated by `/merge-bean` with the git diff summary.

| File | Lines |
|------|-------|
| ai-team-library/claude/commands/long-run.md | +36 -36 |
| ai-team-library/claude/commands/spawn-bean.md | +52 -52 |
| ai-team-library/claude/skills/long-run/SKILL.md | +49 -49 |
| ai/beans/BEAN-221-worktree-agent-merge-gap/bean.md | +91 |
| ai/beans/BEAN-221-worktree-agent-merge-gap/tasks/01-developer-fix-library-templates.md | +62 |
| ai/beans/BEAN-221-worktree-agent-merge-gap/tasks/02-tech-qa-verify-templates.md | +45 |
| ai/beans/_index.md | +1 |

## Notes

Source Trello card includes a detailed spec with root cause analysis and proposed fix. The key insight: Foundry's own long-run works because its orchestrator dashboard loop (Parallel Phase 4) properly monitors status files, merges completed branches, and only then cleans up worktrees. The generated templates for sub-apps must replicate this same pattern.

## Trello

| Field | Value |
|-------|-------|
| **Source** | Trello |
| **Board** | Foundry (ID: 698e9e614a5e03d0ed57f638) |
| **Source List** | Sprint_Backlog |
| **Card ID** | 6999dd5214ce4656a462e4bc |
| **Card Name** | Apps create from foundry have broken long-run |
| **Card URL** | https://trello.com/c/ug7llIg4/89-apps-create-from-foundry-have-broken-long-run |

## Telemetry

| # | Task | Owner | Duration | Tokens In | Tokens Out | Cost |
|---|------|-------|----------|-----------|------------|------|
| 1 | Fix library skill templates for worktree merge loop | Developer | 2m | 1,446,517 | 1,517 | $2.58 |
| 2 | Verify template consistency and correctness | Tech-QA | 1m | 1,790,542 | 308 | $2.93 |

| Metric | Value |
|--------|-------|
| **Total Tasks** | 2 |
| **Total Duration** | 3m |
| **Total Tokens In** | 3,237,059 |
| **Total Tokens Out** | 1,825 |
| **Total Cost** | $5.51 |