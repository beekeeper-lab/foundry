#!/usr/bin/env bash
# post-checkout — self-heal .claude/ content after branch checkouts.
# Initializes the .claude/kit submodule and rebuilds assembly symlinks.
# Install: copy to .git/hooks/post-checkout (or run scripts/claude-sync.sh).
set -euo pipefail

# Only run on branch checkouts (flag=1), not file checkouts (flag=0).
flag="${3:-0}"
if [ "$flag" != "1" ]; then
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"

# --- Initialize submodule if missing ---
if [ -e "$REPO_ROOT/.claude/kit/.git" ] || grep -q '\[submodule.*claude/kit' "$REPO_ROOT/.gitmodules" 2>/dev/null; then
    if [ ! -d "$REPO_ROOT/.claude/kit" ] || [ -z "$(ls -A "$REPO_ROOT/.claude/kit" 2>/dev/null)" ]; then
        echo "[claude-kit] Submodule .claude/kit is missing or empty — initializing..."
        git submodule update --init --recursive
    fi
fi

# --- Rebuild assembly symlinks ---
LINK_SCRIPT="$REPO_ROOT/scripts/claude-link.sh"
if [ -x "$LINK_SCRIPT" ]; then
    "$LINK_SCRIPT"
fi
